<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>NYC Taxis</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.bundle.js"></script>
  <style>
      .chart-container {
        width: 50%;
        max-height: 50%;
      }
  </style>

<body>
    <p id="loading">Loading...</p>
    <button id="up">Up</button>
    <div class="chart-container">
        <canvas id="myChart" width="100" height="100"></canvas>
        <canvas id="myChart2" width="100" height="100"></canvas>
    </div>
    <h2>Options</h2>
    <div>
        <h3>Aggregate</h3>
        <select id="aggregate">
            <option value="count">Count</option>
            <option value="avg">Avg</option>
        </select>
        <select id="aggregateOptionsCount">
            <option value="*">*</option>
        </select>
        <select id="aggregateOptionsAvg" style="display: none">
            <option value="tip">tip</option>
            <option value="fareAmount">fare</option>
            <option value="passengers">passengers</option>
            <option value="tripDistance">distance</option>
        </select>
    </div>
    <div>
        <h3>Where</h3>
        <select id="field">
            <option value="tip">tip</option>
            <option value="fareAmount">fare</option>
            <option value="passengers">passengers</option>
            <option value="tripDistance">distance</option>
        </select>
        <select id="operator">
            <option value="less">less than</option>
            <option value="equal">equal to</option>
            <option value="more">more than</option>
        </select>
        <input type="text" id="value" />
        <button id="and">AND</button>
        <span>-</span>
        <input type="text" id="where" disabled="disabled" />
    </div>
    <button id="send">Add to chart</button>

    <script>
        var chartElem = document.getElementById("myChart")
        var ctx = chartElem.getContext('2d');
        var loading = document.getElementById("loading");
        var up = document.getElementById("up");
        var field = document.getElementById("field");
        var operator = document.getElementById("operator");
        var textArea = document.getElementById("value");
        var andButton = document.getElementById("and");
        var queryButton = document.getElementById("send");
        var whereInput = document.getElementById("where");
        var selectAggregate = document.getElementById("aggregate");
        var aggregateOptionsCount = document.getElementById("aggregateOptionsCount");
        var aggregateOptionsAvg = document.getElementById("aggregateOptionsAvg");
        var selectedAggregateSelect = aggregateOptionsCount;
        var where = null;
        var i = 0;
        var level = 0;
        var month= null;
        var day= null;

        up.style.display = 'none';
        up.onclick = function() {
            level = level - 1;
            if (level < 0) {
                level = 0;
            }
            fetchData();
        }

        selectAggregate.onchange = function() {
            aggregate = selectAggregate.value;
            switch (aggregate) {
                case "count":
                    aggregateOptionsCount.style.display = "inline-block";
                    aggregateOptionsAvg.style.display = "none";
                    selectedAggregateSelect = aggregateOptionsCount;
                    break;
                case "avg":
                    aggregateOptionsCount.style.display = "none";
                    aggregateOptionsAvg.style.display = "inline-block";
                    selectedAggregateSelect = aggregateOptionsAvg;
                    break;
            }
        }

        var myChart;
        var data = {
                labels: [],
                datasets: []
            };

        andButton.onclick = and;
        queryButton.onclick = query;

        function draw() {
            myChart = new Chart(ctx, {
                type: 'line',
                data: data,
                options: {
                    onClick: function(event, elems) {
                        if (elems.length > 0 && level < 2) {
                            var chartData = elems[0]['_chart'].config.data;
                            var idx = elems[0]['_index'];
                            loading.style.display = 'block';
                            if (level === 0) {
                                level = 1;
                                month = chartData.labels[idx];
                                fetchData();
                            } else if (level === 1) {
                                level = 2;
                                day = chartData.labels[idx];
                                fetchData();
                            }
                        }
                        event.stopPropagation();
                    },
                    events: ["click"],
                    scales: {
                        yAxes: [{
                            ticks: {
                                beginAtZero:true
                            }
                        }]
                    }
                }
            });
        }

        function addDataset(newData) {
            i++;
            loading.style.display = 'none';
            data.labels = newData.periods;
            data.datasets.push({
                label: newData.where,
                data: newData.counts
            });
            if (level > 0) {
                up.style.display = 'block';
            }
            chartElem.style.display = 'block';
            myChart.update();
        }

        function getQueryBase() {
            fetchQ = "";
            if (level === 0) {
                month = null;
                fetchQ = "/all?";
            } else if (level === 1) {
                day = null;
                fetchQ = "/all?period=day&month="+month;
            } else if (level === 2) {
                fetchQ = "/all?period=hour&month="+month+"&day="+day;
            }

            return fetchQ;
        }

        function fetchData() {
            where = null;
            loading.style.display = 'block';
            up.style.display = 'none';
            chartElem.style.display = 'none';
            data = {
                labels: [],
                datasets: []
            };

            var fetchQ = getQueryBase()
            var aggregate = selectAggregate.value + "(" + selectedAggregateSelect.value + ")";
            fetch(fetchQ + "&aggregate="+aggregate).then(function(resp) {
                resp.json().then(function(newData) {
                    draw();
                    addDataset(newData);
                });
            });
        }

        function and() {
            var val = field.value;
            var op = operator.value;
            var txt = textArea.value;
            var opVal = "=";
            if (op === "less") {
                opVal = "<";
            } else if (op === "more") {
                opVal = ">";
            }

            var and = val + opVal + txt;
            if (where === null) {
                where = and;
            } else {
                where = where + " and " + and;
            }

            textArea.value = "";
            whereInput.value = where;
        }

        function query() {
            var fetchQ = getQueryBase();
            loading.style.display = 'block';
            chartElem.style.display = 'none';
            whereInput.value = "";
            where = null;
            var aggregate = selectAggregate.value + "(" + selectedAggregateSelect.value + ")";
            var fetchWhere = "";
            if (where != null) {
                fetchWhere="&where="+where;
            }
            fetch(fetchQ + "&aggregate="+aggregate+fetchWhere).then(function(resp) {
                resp.json().then(function(data) {
                    draw();
                    addDataset(data);
                });
            });
        }

        fetchData();
    </script>
</body>
</html>